"use strict";(self.webpackChunk_tiledb_inc_tiledb_prompt_options=self.webpackChunk_tiledb_inc_tiledb_prompt_options||[]).push([[574],{7574:(e,t,n)=>{n.r(t),n.d(t,{default:()=>D});var a=n(1194),o=n(6455),s=n(8324),i=n(3869),r=n(170),l=n(5294),c=n(8959);let d;var u;!function(e){e.v1="v1",e.v2="v2"}(u||(u={}));const p=async(e,t=u.v1)=>(d||(d=await async function(e="",t={}){const n=c.ServerConnection.makeSettings(),a=l.URLExt.join(n.baseUrl,"get_access_token","");let o;try{o=await c.ServerConnection.makeRequest(a,t,n)}catch(e){throw new c.ServerConnection.NetworkError(e)}let s=await o.text();if(s.length>0)try{s=JSON.parse(s)}catch(e){console.log("Not a JSON response body.",o)}if(!o.ok)throw new c.ServerConnection.ResponseError(o,s.message);return s}()),new e({apiKey:d.token,basePath:`${d.api_host}/${t}`}));var m=n(9321);const h=(e,t,n,a)=>{t.forEach(((t,o)=>{const s=a?a[o]:t,i=document.createElement("option");i.setAttribute("value",t),i.setAttribute("label",s),n&&n===t&&i.setAttribute("selected","true"),e.append(i)}))};var _=n(3706);const{UserApi:b,OrganizationApi:g}=a.v1,{UserApi:v}=a.v2;class f extends _.Widget{constructor(e){const t=document.createElement("div");super({node:t}),this.addClass("TDB-Prompt-Dialog"),this.app=e.app,this.docManager=e.docManager,this.isDefaultS3PathInputDirty=!1;const n=document.createElement("label");n.textContent="Name:";const a=document.createElement("input");a.setAttribute("type","text"),a.setAttribute("value","untitled"),a.setAttribute("name","name"),a.setAttribute("required","true"),a.setAttribute("pattern","^[^0-9][A-Za-z0-9_-]*"),a.setAttribute("maxlength","250"),a.setAttribute("oninput",'this.setCustomValidity("")'),a.addEventListener("invalid",(e=>{e.target.validity.valueMissing?e.target.setCustomValidity("This field is required"):e.target.setCustomValidity('Name should not start with a numeric character and consist of letters(a -z and A-Z), numbers, "_" and "-" only')}));const o=document.createElement("label");o.textContent="Cloud storage path:";const s=document.createElement("input");s.setAttribute("type","text"),s.setAttribute("value",e.defaultS3Path),s.setAttribute("name","s3_prefix"),s.onchange=()=>{this.isDefaultS3PathInputDirty=!0};const i=document.createElement("label");i.textContent="Cloud storage credentials:";const r=document.createElement("select");r.setAttribute("name","s3_credentials");const l=e.credentials.map((e=>e.name));h(r,l,e.defaultS3CredentialName);const c=document.createElement("a");c.textContent="Add credentials",c.classList.add("TDB-Prompt-Dialog__link"),c.onclick=()=>{window.parent.postMessage("@tiledb/prompt_options::add_credentials","*")};const d=document.createElement("label");d.textContent="Owner:";const m=document.createElement("select");h(m,e.owners,e.selectedOwner),m.setAttribute("name","owner"),m.onchange=async t=>{const n=t.currentTarget.value;var a;(a=r).value="",a.innerHTML="";const o=await p(v,u.v2),i=(await o.listCredentials(n)).data.credentials||[],l=e.owners[0],{default_s3_path_credentials_name:c,default_s3_path:d}=await(async(e,t)=>{const n=await p(b),a=await p(g),o=e!==t,s=await(o?a.getOrganization(t):n.getUser());return{default_s3_path:s.data.default_s3_path,default_s3_path_credentials_name:s.data.default_s3_path_credentials_name}})(l,n);d&&!this.isDefaultS3PathInputDirty&&s.setAttribute("value",d);const m=i.map((e=>e.name));h(r,m,c)};const _=document.createElement("label");_.textContent="Kernel:";const f=document.createElement("select");f.setAttribute("name","kernel");const w=this.docManager.services.kernelspecs.specs,y=Object.keys(w.kernelspecs),C=Object.values(w.kernelspecs).map((e=>e.display_name)),D=w.default;h(f,y,D,C);const k=document.createElement("form");k.classList.add("TDB-Prompt-Dialog__form"),t.appendChild(k),k.appendChild(n),k.appendChild(a),k.appendChild(o),k.appendChild(s),k.appendChild(i),k.appendChild(r),k.appendChild(c),k.appendChild(d),k.appendChild(m),k.appendChild(_),k.appendChild(f),window.addEventListener("message",(async t=>{var n,a;if("TILEDB_UPDATED_CREDENTIALS"===t.data){const t=await p(v,u.v2),o=e.owners[0],s=await t.listCredentials(o);r.innerHTML="";const i=null===(a=null===(n=null==s?void 0:s.data)||void 0===n?void 0:n.credentials)||void 0===a?void 0:a.map((e=>e.name));h(r,i,e.defaultS3CredentialName)}}))}onAfterAttach(){var e;const t=null===(e=document.querySelector(".TDB-Prompt-Dialog"))||void 0===e?void 0:e.nextElementSibling,n=document.createElement("button");n.classList.add("TDB-Prompt-Dialog__styled-btn","jp-Dialog-button","jp-mod-accept","jp-mod-styled"),n.textContent="GO",n.onclick=()=>function(e,t){const n=document.querySelector(".TDB-Prompt-Dialog__styled-btn"),a=document.querySelector(".TDB-Prompt-Dialog__btn"),o=document.querySelector(".TDB-Prompt-Dialog__form"),s=new FormData(o);if(!o.reportValidity())return;n.textContent="";const i=document.createElement("div");i.classList.add("TDB-Prompt-Dialog__loader"),n.appendChild(i);const{name:r,owner:l,s3_credentials:c,s3_prefix:d,kernel:u}=function(e){const t={};for(const n of e.keys())t[n]=e.get(n);return t}(s),p={name:r,s3_prefix:d,s3_credentials:c},h={name:u},_={path:"cloud/owned/".concat(l,"/"),type:"notebook",options:JSON.stringify(p)};t.services.contents.newUntitled(_).then((t=>{e.commands.execute("docmanager:open",{factory:"Notebook",path:t.path+".ipynb",kernel:h}).finally((()=>{a.click()}))})).catch((e=>{(0,m.showErrorMessage)("Error",e),a.click()}))}(this.app,this.docManager),t.appendChild(n)}getValue(){const e=this.node.getElementsByTagName("input"),t=this.node.getElementsByTagName("select");return{name:e[0].value,s3_prefix:e[1].value,s3_credentials:t[0].value,owner:t[1].value,kernel:t[2].value}}}const{UserApi:w}=a.v1,{UserApi:y}=a.v2,C={activate:function(e,t,n,a,o){const s="tiledb-prompt-notebook-options:open";e.commands.addCommand(s,{caption:"Prompt the user for TileDB notebook options",execute:async()=>{var t;const a=await p(w),o=await p(y,u.v2),s=(await a.getUser()).data,i=s.username,r=await o.listCredentials(i),l=[i],c=function(e){const t=[];return e.forEach((e=>{const n=e.organization_name;"public"!==n&&~(null==e?void 0:e.allowed_actions.indexOf("write"))&&t.push(n)})),t}(s.organizations||[]),d=s.default_s3_path||"s3://tiledb-user/notebooks";l.push(...c),(e=>{(0,m.showDialog)({body:new f(e),buttons:[m.Dialog.cancelButton(),m.Dialog.okButton({label:"GO",className:"TDB-Prompt-Dialog__btn"})],title:"TileDB Notebook Options"})})({owners:l,credentials:(null===(t=r.data)||void 0===t?void 0:t.credentials)||[],defaultS3Path:d,defaultS3CredentialName:s.default_s3_path_credentials_name,app:e,docManager:n,selectedOwner:s.username})},isEnabled:()=>!0,label:"TileDB Notebook"}),o&&o.add({args:{isLauncher:!0,kernelName:"tiledb-prompt-notebook-options"},category:"Notebook",command:s,kernelIconUrl:"https://cloud.tiledb.com/static/img/tiledb-logo-jupyterlab.svg",rank:1}),t&&t.fileMenu.newMenu.addGroup([{command:s}],40),console.log("JupyterLab extension @tiledb/tiledb_prompt_options is activated.")},autoStart:!0,id:"tiledb-prompt-notebook-options",optional:[i.ILauncher],requires:[r.IMainMenu,o.IDocumentManager,s.IFileBrowserFactory]},D=C}}]);