<!doctype html>
<html>

<head>
    <base href="{{base_url}}/">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.10/vue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.2.27/dist/vuetify.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.2.27/dist/vuetify.min.css" rel="stylesheet">
    <link href='https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900|Material+Icons' rel="stylesheet">
    <link href='https://cdn.materialdesignicons.com/4.9.95/css/materialdesignicons.min.css' rel="stylesheet">
    <link rel="icon" type="image/png" href="static/sun64.png">

    <link href="static/highlight.css" rel="stylesheet">
    </link>
    <link href="static/style.css" rel="stylesheet">
    </link>
    <link href="solara/static/index.css" rel="stylesheet">
    </link>
    <link href="solara/static/theme-light.css" rel="stylesheet">
    </link>
    <title>Hello from Solara ☀️</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.js" crossorigin="anonymous">
    </script>
    <script src="static/main-vuetify.js"></script>
    <script src="static/ansi.js"></script>
    </script>

    <script id="jupyter-config-data" type="application/json">
    {
        "baseUrl": "{{base_url}}/jupyter",
        "kernelId": "1234"
    }
    </script>



    <style>
        html,
        body {
            height: 100vh;
        }

        .ipywidgets-server-contents-container {
            height: 95vh;
            padding-top: 5vh;
        }

        #result {
            margin-top: auto;
            margin-bottom: auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(359deg);
            }
        }

        @keyframes oscillate {
            0% {
                transform: scale(0.8);
                fill: red;
            }

            50% {
                transform: scale(1.0);
            }

            100% {
                transform: scale(0.8);
            }
        }

        #sun-spinner {
            animation: spin 10s linear infinite;
            padding: 10px;
        }

        #sun-spinner-container {
            animation: oscillate 2s linear infinite;
        }

        @keyframes bounce-in {
            0% {
                transform: scale(0);
            }

            100% {
                transform: scale(1);
            }
        }

        @keyframes bounce-out {
            0% {
                transform: translateZ(0) scale(1);
            }

            100% {
                transform: translateZ(0) scale(50);
            }
        }

        .solara-transition-enter-active {
            transition: opacity 0.5s ease;
            /* animation: bounce-in 0.5s ease; */
        }

        .solara-transition-leave-active {
            transition: opacity 0.5s ease;
        }

        .solara-transition-leave-active .solara-loader {
            animation: bounce-out 0.5s ease;
        }

        .solara-transition-leave-active #sun-spinner-container {
            animation: unset;
        }

        .solara-transition-leave-active h1 {
            visibility: hidden;
        }

        .solara-transition-enter,
        .solara-transition-leave-to {
            opacity: 0;
        }

        #sun-spinner-container {
            overflow: hidden;
        }

        #loader-container {
            width: 100vw;
            height: 100vh;
            position: absolute;
            margin: 0;
            padding: 0;
            z-index: 998;
        }

        #loader {
            position: absolute;
            width: 100vw;
            top: 50%;
            /* position the top  edge of the element at the middle of the parent */
            left: 50%;
            /* position the left edge of the element at the middle of the parent */

            margin-left: auto;
            margin-right: auto;
            left: 0;
            right: 0;
            text-align: center;
            z-index: 1000;
            overflow: hidden;
        }


        /* from https://codepen.io/elchiconube/pen/naxOWv */
        #clouds {
            position: absolute;
            overflow: hidden;
            z-index: 999;
            width: 100vw;
            height: 60vh;
            padding: 100px 0;
            background: #00b4ff;
            background: -webkit-linear-gradient(top, #00b4ff 0%, #fff0 100%);
            background: -linear-gradient(top, #00b4ff 0%, #fff0 100%);
            background: -moz-linear-gradient(top, #00b4ff 0%, #fff0 100%);
        }

        /*Time to finalise the cloud shape*/
        .cloud {
            width: 200px;
            height: 60px;
            background: #fff;

            border-radius: 200px;
            -moz-border-radius: 200px;
            -webkit-border-radius: 200px;

            position: relative;
        }

        .cloud:before,
        .cloud:after {
            content: '';
            position: absolute;
            background: #fff;
            width: 100px;
            height: 80px;
            position: absolute;
            top: -15px;
            left: 10px;

            border-radius: 100px;
            -moz-border-radius: 100px;
            -webkit-border-radius: 100px;

            -webkit-transform: rotate(30deg);
            transform: rotate(30deg);
            -moz-transform: rotate(30deg);
        }

        .cloud:after {
            width: 120px;
            height: 120px;
            top: -55px;
            left: auto;
            right: 15px;
        }

        /*Time to animate*/
        .x1 {
            -webkit-animation: moveclouds 15s linear infinite;
            -moz-animation: moveclouds 15s linear infinite;
            -o-animation: moveclouds 15s linear infinite;
        }

        /*variable speed, opacity, and position of clouds for realistic effect*/
        .x2 {
            left: 200px;

            -webkit-transform: scale(0.6);
            -moz-transform: scale(0.6);
            transform: scale(0.6);
            opacity: 0.6;
            /*opacity proportional to the size*/

            /*Speed will also be proportional to the size and opacity*/
            /*More the speed. Less the time in 's' = seconds*/
            -webkit-animation: moveclouds 25s linear infinite;
            -moz-animation: moveclouds 25s linear infinite;
            -o-animation: moveclouds 25s linear infinite;
        }

        .x3 {
            left: -250px;
            top: -200px;

            -webkit-transform: scale(0.8);
            -moz-transform: scale(0.8);
            transform: scale(0.8);
            opacity: 0.8;
            /*opacity proportional to the size*/

            -webkit-animation: moveclouds 20s linear infinite;
            -moz-animation: moveclouds 20s linear infinite;
            -o-animation: moveclouds 20s linear infinite;
        }

        .x4 {
            left: 470px;
            top: -250px;

            -webkit-transform: scale(0.75);
            -moz-transform: scale(0.75);
            transform: scale(0.75);
            opacity: 0.75;
            /*opacity proportional to the size*/

            -webkit-animation: moveclouds 18s linear infinite;
            -moz-animation: moveclouds 18s linear infinite;
            -o-animation: moveclouds 18s linear infinite;
        }

        .x5 {
            left: -150px;
            top: -150px;

            -webkit-transform: scale(0.8);
            -moz-transform: scale(0.8);
            transform: scale(0.8);
            opacity: 0.8;
            /*opacity proportional to the size*/

            -webkit-animation: moveclouds 20s linear infinite;
            -moz-animation: moveclouds 20s linear infinite;
            -o-animation: moveclouds 20s linear infinite;
        }

        @-webkit-keyframes moveclouds {
            0% {
                margin-left: 1000px;
            }

            100% {
                margin-left: -1000px;
            }
        }

        @-moz-keyframes moveclouds {
            0% {
                margin-left: 1000px;
            }

            100% {
                margin-left: -1000px;
            }
        }

        @-o-keyframes moveclouds {
            0% {
                margin-left: 1000px;
            }

            100% {
                margin-left: -1000px;
            }
        }
    </style>
</head>

<body>
    {% raw -%}
    <div id="app" style="display: none">
        <v-app :key="forceUpdateTrigger">
            <transition name="solara-transition" :duration="{ enter: 500, leave: 500 }">
                <div v-if="loading" id="loader-container">
                    <div id="clouds" key="clouds" class="solara-clouds">
                        <div class="cloud x1"></div>
                        <!-- Time for multiple clouds to dance around -->
                        <div class="cloud x2"></div>
                        <div class="cloud x3"></div>
                        <div class="cloud x4"></div>
                        <div class="cloud x5"></div>
                    </div>
                    <v-container id="loader" key="loader" class="solara-loader">
                        <v-row>
                            <v-col>
                                <div id="sun-spinner-container">
                                    <img id="sun-spinner" height="100px" src="static/sun.svg" />
                                </div>
                                <h1>Solara is {{ loading_text }}</h1>

                            </v-col>
                        </v-row>
                    </v-container>
                </div>
                <jupyter-widget-mount-point v-if="!loading" mount-id="content">
                    A widget with mount-id="content" should go here
                </jupyter-widget-mount-point>
            </transition>

            <v-menu v-if="debug && voilaDebugMessages && voilaDebugMessages.length" offset-y top
                :close-on-content-click="false">
                <template v-slot:activator="{ on }">
                    <v-btn text v-on="on" style="position: fixed; bottom: 8px; right: 8px">
                        <span style="color: red">{{ voilaDebugMessages.length }}</span>
                        <v-icon right large color="red">mdi-bug-outline</v-icon>
                    </v-btn>
                </template>
                <v-sheet class="pa-2" style="overflow: auto; max-height: 80vh">
                    <div style="display: flex" v-for="message in voilaDebugMessages" :key="message.cell" class="pa-2">
                        <div style="width: 50px">[{{ message.cell }}]</div>
                        <div v-if="message.traceback" class="jp-RenderedText jp-OutputArea-output"
                            data-mime-type="application/vnd.jupyter.stderr">
                            <pre v-html="message.traceback" class="pa-2"></pre>
                        </div>
                        <pre v-else><span :style="message.name === 'stderr' ? 'background-color: var(--jp-rendermime-error-background)' : ''"
                                   class="pa-2"
                                >{{ message.text }}</span>
                        </pre>
                    </div>
                    <div class="d-flex justify-end">
                        <v-tooltip top>
                            <template v-slot:activator="{ on, attrs }">
                                <v-btn icon v-bind="attrs" v-on="on" @click="voilaDebugMessages = []">
                                    <v-icon>mdi-trash-can-outline</v-icon>
                                </v-btn>
                            </template>
                            <span>Clear messages</span>
                        </v-tooltip>
                    </div>
                </v-sheet>
            </v-menu>

            <v-menu offset-y top :close-on-content-click="false">
                <template v-slot:activator="{ on }">
                    <v-btn text v-on="on" style="position: fixed; top: 8px; right: 8px">
                        <v-icon right large color="#333">mdi-account</v-icon>
                    </v-btn>
                </template>
                <v-list>
                    <v-list-item @click="stateReset()" link>
                        <v-list-item-icon>
                            <v-icon>mdi-close-box</v-icon>
                        </v-list-item-icon>
                        <v-list-item-title>Reset application state
                        </v-list-item-title>
                    </v-list-item>
                </v-list>
            </v-menu>
            <!-- <v-menu v-if="debug && outputMessages && outputMessages.length" offset-y top
                :close-on-content-click="false">
                <template v-slot:activator="{ on }">
                    <v-btn text v-on="on" style="position: fixed; top: 8px; right: 8px">
                        <span style="color: #333">{{ outputMessages.length }}</span>
                        <v-icon right large color="#333">mdi-information-outline</v-icon>
                    </v-btn>
                </template>
                <v-sheet class="pa-2" style="overflow: auto; max-height: 80vh">
                    <div style="display: flex" v-for="message in outputMessages" :key="message.cell" class="pa-2">
                        <div style="width: 50px">[{{ message.cell }}]</div>
                        <div v-if="message.traceback" class="jp-RenderedText jp-OutputArea-output"
                            data-mime-type="application/vnd.jupyter.stderr">
                            <pre v-html="message.traceback" class="pa-2"></pre>
                        </div>
                        <pre v-else><span :style="message.name === 'stderr' ? 'background-color: var(--jp-rendermime-error-background)' : ''"
                                   class="pa-2"
                                >{{ message.text }}</span>
                        </pre>
                    </div>
                    <div class="d-flex justify-end">
                        <v-tooltip top>
                            <template v-slot:activator="{ on, attrs }">
                                <v-btn icon v-bind="attrs" v-on="on" @click="outputMessages = []">
                                    <v-icon>mdi-trash-can-outline</v-icon>
                                </v-btn>
                            </template>
                            <span>Clear messages</span>
                        </v-tooltip>
                    </div>
                </v-sheet>
            </v-menu> -->
        </v-app>
    </div>
    {% endraw -%}
    <script>
        window.for_pyodide = false;
        {% if for_pyodide %}
        const solaraWorker = new Worker("./static/webworker.js");
        window.for_pyodide = true;
        {% endif %}
        var debug = true;
        var app = new Vue({
            vuetify: new Vuetify({
                theme: { dark: themeIsdark },
            }),
            el: '#app',
            created() {
                const original_$forceUpdate = this.$forceUpdate.bind(this);
                this.$forceUpdate = (() => {
                    this.forceUpdateTrigger += 1;
                    original_$forceUpdate();
                });
            },
            mounted() {
                document.querySelector('#app').removeAttribute("style");
            },
            methods: {
                stateReset() {
                    console.log('reset')
                    msg = { "type": "state_reset", "reason": "user command" }
                    wsWatchdog.send(JSON.stringify(msg))
                }
            },
            data() {
                return {
                    forceUpdateTrigger: 0,
                    loading_text: "loading the page",
                    loadingPercentage: -1,
                    loading: true,
                    title: "No title",
                    voilaDebugMessages: [],
                    outputMessages: [],
                    // outputMessages: [{ name: 'stderr', text: 'lala' }],
                }
            }
        });
        requirejs.config({ baseUrl: '{{base_url}}voila/', waitSeconds: 30 });

        // Loading classic notebook extensions.
        {% if 'jupyter-vuetify/extension' in resources.nbextensions -%}
        window.enable_nbextensions = true;
        {% endif -%}
        requirejs.config({
            baseUrl: '{{resources.base_url}}voila',
            waitSeconds: 3000,
            map: {
                '*': {
                        {% if 'jupyter-vue/extension' in resources.nbextensions -%}
        'jupyter-vue': 'nbextensions/jupyter-vue/nodeps',
            {% endif -%}
        {% if 'jupyter-vuetify/extension' in resources.nbextensions -%}
        'jupyter-vuetify': 'nbextensions/jupyter-vuetify/nodeps',
            {% endif -%}
                    },
                }
            });
        requirejs([
            {% for ext in resources.nbextensions if ext != 'jupyter-vuetify/extension' and ext != 'jupyter-vue/extension' -%}
        "{{resources.base_url}}voila/nbextensions/{{ ext }}.js",
            {% endfor %}
        ]);

        window.solaraInitialized = solaraInit()
        {% if not for_pyodide %}
            solaraMount("{{model_id}}")
        {% endif %}

    </script>

</html>
